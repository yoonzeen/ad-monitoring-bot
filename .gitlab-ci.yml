image: mcr.microsoft.com/playwright:v1.58.2-jammy

# 전역 타임아웃을 10분으로 넉넉하게 설정
variables:
  FF_USE_FASTZIP: "true"
  # Playwright Docker image already contains browsers.
  # Avoid re-downloading browsers during `npm ci/install` (can be huge and lead to job timeouts).
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
  npm_config_fund: "false"
  npm_config_audit: "false"

pages:
  stage: deploy
  timeout: 10m  # 이 작업이 최대 10분까지 돌 수 있게 허용
  script:
    - node --version
    - npm --version
    - npm ci
    # Build dashboard for GitLab Pages
    - VITE_BASE="/${CI_PROJECT_NAME}/" npm run build

    # Generate monitor-report.json into dist/ so it is always deployed.
    - |
      mkdir -p dist
      if [ -n "${MONITOR_TARGET_URL}" ]; then
        MONITOR_REPORT_PATH="dist/monitor-report.json" npm run monitor || true
      else
        echo "Skipping monitor: MONITOR_TARGET_URL is not set"
      fi
      if [ ! -f dist/monitor-report.json ]; then
        echo "monitor-report.json was not produced. Writing placeholder."
        cat > dist/monitor-report.json <<'EOF'
        {
          "ok": false,
          "url": "",
          "status": 0,
          "durationMs": 0,
          "checkedAt": "",
          "failures": ["monitor-report.json was not produced (monitor crashed or misconfigured)"],
          "diagnostics": { "pageErrors": [], "consoleMessages": [], "requestFailures": [] }
        }
        EOF
      fi

    # Append history.json (best-effort; if Pages URL is not available yet, it will start fresh).
    - |
      HISTORY_SOURCE_URL="${CI_PAGES_URL}/history.json" \
      REPORT_PATH="dist/monitor-report.json" \
      HISTORY_PATH="dist/history.json" \
      HISTORY_MAX="720" \
      GITHUB_RUN_URL="" \
      node ./scripts/update-history.js || true

    - rm -rf public && mkdir -p public
    - cp -r dist/* public/
    - ls -la public | sed -n '1,160p'
  artifacts:
    paths:
      - public
  only:
    - main